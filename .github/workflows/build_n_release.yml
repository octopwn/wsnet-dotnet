name: Build .NET Framework 4.7 Project

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types:
      - created

jobs:
  build:
    runs-on: windows-2019

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install .NET Framework 4.7.2 Developer Pack
      run: |
        choco install netfx-4.7.2-devpack --ignore-checksums -y

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1

    - name: Restore NuGet packages
      run: nuget restore WSNetFramework.sln

    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v1

    - name: Build project
      run: msbuild WSNetFramework.sln /p:Configuration=Release /p:Platform="Any CPU"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: wsnet_dotnet
        path: WSNetFramework\bin\Release\WSNetFramework.exe

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Upload wsnet-dotnet source zip to R2 (staging)
      if: github.event_name == 'push'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      shell: bash
      run: |
        7z a -tzip wsnet_dotnet.zip . -x!.git -x!WSNetFramework/bin -x!WSNetFramework/obj -x!packages
        npx wrangler r2 object put "octopwn-core-staging/wsnet/wsnet_dotnet.zip" --file="wsnet_dotnet.zip" --remote

    - name: Upload wsnet-dotnet source zip to R2 (production)
      if: github.event_name == 'release'
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      shell: bash
      run: |
        7z a -tzip wsnet_dotnet.zip . -x!.git -x!WSNetFramework/bin -x!WSNetFramework/obj -x!packages
        npx wrangler r2 object put "octopwn-core/wsnet/wsnet_dotnet.zip" --file="wsnet_dotnet.zip" --remote
